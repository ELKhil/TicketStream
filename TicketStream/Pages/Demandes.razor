@page "/demandes"
@attribute [Authorize]
@inject DemandeApiService DemandeApi
@inject UserApiService UserApi
@inject NavigationManager Nav
@inject UserState UserState

<!-- Titre adapté selon le rôle -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">@(UserState.IsAgent ? "Demandes" : "Mes demandes")</h3>
    @if (!UserState.IsAgent)
    {
        <!-- Bouton de création visible uniquement pour ROLE_USER -->
        <a href="/demandes/creer" class="btn btn-primary btn-sm">+ Créer une demande</a>
    }
</div>

<!-- Barre de filtres -->
<div class="filter-bar">
    <div class="row g-2 align-items-end">

        <!-- Filtre statut (tous les rôles) -->
        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
            <label class="filter-label">Statut</label>
            <select @bind="filtreStatus" class="form-select form-select-sm">
                <option value="">Tous</option>
                <option value="EnAttente">En attente</option>
                <option value="EnCours">En cours</option>
                <option value="Termine">Terminé</option>
            </select>
        </div>

        @if (UserState.IsAgent)
        {
            <!-- Filtre par agent assigné (ROLE_AGENT uniquement) -->
            <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                <label class="filter-label">Agent assigné</label>
                <select @bind="filtreAgentId" class="form-select form-select-sm">
                    <option value="">Tous les agents</option>
                    @foreach (var agent in agents)
                    {
                        <option value="@agent.Id">@agent.Name</option>
                    }
                </select>
            </div>

            <!-- Filtre assignée / non assignée -->
            <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                <label class="filter-label">Assignation</label>
                <select @bind="filtreIsAssigned" class="form-select form-select-sm">
                    <option value="">Toutes</option>
                    <option value="true">Assignées</option>
                    <option value="false">Non assignées</option>
                </select>
            </div>

            <!-- Tri par date de création -->
            <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                <label class="filter-label">Date de création</label>
                <select @bind="filtreTri" class="form-select form-select-sm">
                    <option value="recentes">Récentes</option>
                    <option value="anciennes">Anciennes</option>
                </select>
            </div>
        }

        <!-- Boutons -->
        <div class="col-12 col-sm-auto ms-sm-auto">
            <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm flex-grow-1 flex-sm-grow-0"
                        @onclick="Filtrer">
                    <i class="bi bi-funnel me-1"></i>Filtrer
                </button>
                <button class="btn btn-outline-secondary btn-sm flex-grow-1 flex-sm-grow-0"
                        @onclick="Reinitialiser">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Réinitialiser
                </button>
            </div>
        </div>

    </div>
</div>

<!-- Tableau des demandes -->
@if (demandes == null)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Chargement...</p>
    </div>
}
else if (demandes.Count == 0)
{
    <div class="alert alert-info">Aucune demande trouvée.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Titre</th>
                    <th>Statut</th>
                    <th>Créé par</th>
                    @if (UserState.IsAgent)
                    {
                        <th>Agent assigné</th>
                        <th>Date création</th>
                    }
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var d in demandes)
                {
                    <tr>
                        <td><strong>@d.Title</strong></td>
                        <td>
                            <span class="badge badge-statut @ClasseStatut(d.Status)">
                                @LibelleStatut(d.Status)
                            </span>
                        </td>
                        <td>@(d.User?.Name ?? "—")</td>
                        @if (UserState.IsAgent)
                        {
                            <td>@(d.AssignedAgent?.Name ?? "—")</td>
                            <td>@d.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                        }
                        <td>
                            <a href="/demandes/@d.Id" class="btn btn-sm btn-outline-primary">Voir</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<DemandeDto>? demandes;
    private List<UserDto>     agents = new List<UserDto>();

    // Valeurs des filtres
    private string filtreStatus     = "";
    private string filtreAgentId    = "";
    private string filtreIsAssigned = "";
    private string filtreTri        = "recentes";

    protected override async Task OnInitializedAsync()
    {
        // Charge la liste des agents pour le filtre (ROLE_AGENT uniquement)
        if (UserState.IsAgent)
            agents = await UserApi.GetAgentsAsync();

        await ChargerDemandes();
    }

    // Charge les demandes selon les filtres actifs
    private async Task ChargerDemandes()
    {
        demandes = null;

        // Résout le filtre agent/assignation (assignedAgentId prend la priorité sur isAssigned)
        Guid? agentId  = Guid.TryParse(filtreAgentId, out var g) ? g : null;
        bool? assigned = string.IsNullOrEmpty(filtreIsAssigned) ? null : bool.Parse(filtreIsAssigned);

        demandes = await DemandeApi.GetDemandesAsync(
            status:          string.IsNullOrEmpty(filtreStatus) ? null : filtreStatus,
            assignedAgentId: agentId,
            isAssigned:      agentId.HasValue ? null : assigned, // ignoré si agent précis fourni
            tri:             filtreTri);
    }

    private async Task Filtrer()      => await ChargerDemandes();
    private async Task Reinitialiser()
    {
        filtreStatus     = "";
        filtreAgentId    = "";
        filtreIsAssigned = "";
        filtreTri        = "recentes";
        await ChargerDemandes();
    }

    // Traduit le statut API en libellé lisible
    private static string LibelleStatut(string status) => status switch
    {
        "EnAttente" => "En attente",
        "EnCours"   => "En cours",
        "Terminé"   => "Terminé",
        _           => status
    };

    // Classe Bootstrap pour le badge de statut
    private static string ClasseStatut(string status) => status switch
    {
        "EnAttente" => "bg-warning text-dark",
        "EnCours"   => "bg-info text-dark",
        "Terminé"   => "bg-success",
        _           => "bg-secondary"
    };
}
