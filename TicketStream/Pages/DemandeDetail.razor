@page "/demandes/{Id:guid}"
@attribute [Authorize]
@inject DemandeApiService DemandeApi
@inject CommentaireApiService CommentaireApi
@inject UserApiService UserApi
@inject NavigationManager Nav
@inject ToastService Toast
@inject UserState UserState

<ConfirmModal @ref="confirmModal" />

@if (demande == null && !erreurChargement)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Chargement de la demande...</p>
    </div>
}
else if (erreurChargement)
{
    <div class="alert alert-danger">Demande introuvable ou accès non autorisé.</div>
    <a href="/demandes" class="btn btn-outline-secondary btn-sm">← Retour</a>
}
else if (demande != null)
{
    <!-- En-tête de la demande -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <a href="/demandes" class="text-muted small">← Retour</a>
            <h3 class="mt-1 mb-0">@demande.Title</h3>
        </div>
        <div class="d-flex gap-2">
            @if (peutModifier && !modeEdition)
            {
                <button class="btn btn-outline-primary btn-sm"
                        @onclick="() => modeEdition = true">
                    Modifier
                </button>
            }
            @if (peutSupprimer)
            {
                <button class="btn btn-outline-danger btn-sm" @onclick="Supprimer">
                    Supprimer
                </button>
            }
        </div>
    </div>

    <!-- ===== MODE AFFICHAGE ===== -->
    @if (!modeEdition)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="text-muted small">Description</label>
                        <p class="mb-0">@demande.Description</p>
                    </div>
                    <div class="col-md-4">
                        <label class="text-muted small">Statut</label>
                        @if (isAgent)
                        {
                            <!-- Select inline : modification rapide du statut sans passer par le mode édition -->
                            <div class="d-flex align-items-center gap-2">
                                <select value="@inlineStatus" @onchange="OnStatutChange"
                                        class="form-select form-select-sm quick-action-select"
                                        disabled="@chargementStatut">
                                    <option value="EnAttente">En attente</option>
                                    <option value="EnCours">En cours</option>
                                    <option value="Terminé">Terminé</option>
                                </select>
                                @if (chargementStatut)
                                {
                                    <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
                                }
                            </div>
                        }
                        else
                        {
                            <div>
                                <span class="badge badge-statut @ClasseStatut(demande.Status)">
                                    @LibelleStatut(demande.Status)
                                </span>
                            </div>
                        }
                    </div>
                    <div class="col-md-4">
                        <label class="text-muted small">Créé par</label>
                        <p class="mb-0">@(demande.User?.Name ?? "—")</p>
                    </div>
                    <div class="col-md-4">
                        <label class="text-muted small">Date de création</label>
                        <p class="mb-0">@demande.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                    <div class="col-md-4">
                        <label class="text-muted small">Agent assigné</label>
                        @if (isAgent)
                        {
                            <!-- Select inline : assignation rapide sans passer par le mode édition -->
                            <div class="d-flex align-items-center gap-2">
                                <select value="@inlineAgentId" @onchange="OnAgentChange"
                                        class="form-select form-select-sm quick-action-select"
                                        disabled="@chargementAgent">
                                    <option value="">Aucun</option>
                                    @foreach (var agent in agents)
                                    {
                                        <option value="@agent.Id">@agent.Name</option>
                                    }
                                </select>
                                @if (chargementAgent)
                                {
                                    <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="mb-0">@(demande.AssignedAgent?.Name ?? "—")</p>
                        }
                    </div>
                    @if (demande.AssignedAt.HasValue)
                    {
                        <div class="col-md-4">
                            <label class="text-muted small">Date d'assignation</label>
                            <p class="mb-0">@demande.AssignedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                    }
                    @if (demande.UpdatedBy != null)
                    {
                        <div class="col-md-6">
                            <label class="text-muted small">Dernière modification</label>
                            <p class="mb-0">
                                par @demande.UpdatedBy.Name
                                le @demande.UpdatedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            </p>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- ===== MODE ÉDITION ===== -->
    @if (modeEdition)
    {
        <div class="card shadow-sm mb-4 border-primary">
            <div class="card-header bg-primary text-white">Modifier la demande</div>
            <div class="card-body">
                <div class="row g-3">
                    @if (!isAgent || demande!.UserId == userId)
                    {
                        <!-- Titre et description : visibles uniquement pour le propriétaire -->
                        <div class="col-12">
                            <label class="form-label">Titre</label>
                            <input @bind="editTitre" class="form-control" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea @bind="editDescription" class="form-control" rows="4"></textarea>
                        </div>
                    }

                    @if (isAgent)
                    {
                        <!-- Statut : modifiable uniquement par ROLE_AGENT -->
                        <div class="col-md-4">
                            <label class="form-label">Statut</label>
                            <select @bind="editStatus" class="form-select">
                                <option value="EnAttente">En attente</option>
                                <option value="EnCours">En cours</option>
                                <option value="Terminé">Terminé</option>
                            </select>
                        </div>
                    }

                    @if (isAgent)
                    {
                        <!-- Agent assigné (ROLE_AGENT uniquement) -->
                        <div class="col-md-4">
                            <label class="form-label">Agent assigné</label>
                            <select @bind="editAgentId" class="form-select">
                                <option value="">Aucun</option>
                                @foreach (var agent in agents)
                                {
                                    <option value="@agent.Id">@agent.Name</option>
                                }
                            </select>
                        </div>
                    }
                </div>

                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary" @onclick="DemanderConfirmationSauvegarde" disabled="@chargementEdit">
                        @if (chargementEdit) { <span>Sauvegarde...</span> }
                        else                 { <span>Sauvegarder</span> }
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="AnnulerEdition">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- ===== SECTION COMMENTAIRES ===== -->
    <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-chat-dots text-primary"></i>
            <h5 class="mb-0">Commentaires (@commentaires.Count)</h5>
        </div>
        <div class="card-body">

            <!-- Liste des commentaires en style bulle -->
            @if (commentaires.Count == 0)
            {
                <div class="text-center py-4">
                    <i class="bi bi-chat-dots" style="font-size:2.2rem;opacity:.2;"></i>
                    <p class="text-muted mt-2 mb-0 fw-semibold">Aucun commentaire pour le moment.</p>
                    <small class="text-muted">Soyez le premier à réagir.</small>
                </div>
            }
            else
            {
                <div class="chat-container">

                    @{
                        int nbCaches = Math.Max(0, commentaires.Count - NbCommentairesParDefaut);
                    }

                    <!-- Bouton « Voir les X précédents » -->
                    @if (!tousCommentairesVisibles && nbCaches > 0)
                    {
                        <div class="chat-voir-plus-wrapper">
                            <button class="btn-voir-plus"
                                    @onclick="() => tousCommentairesVisibles = true">
                                <i class="bi bi-chevron-up"></i>
                                Voir @nbCaches commentaire@(nbCaches > 1 ? "s" : "") précédent@(nbCaches > 1 ? "s" : "")
                            </button>
                        </div>
                    }

                    <!-- Bouton « Réduire » quand tout est affiché -->
                    @if (tousCommentairesVisibles && commentaires.Count > NbCommentairesParDefaut)
                    {
                        <div class="chat-voir-plus-wrapper">
                            <button class="btn-voir-plus btn-voir-plus-reduire"
                                    @onclick="() => tousCommentairesVisibles = false">
                                <i class="bi bi-chevron-down"></i>
                                Réduire
                            </button>
                        </div>
                    }

                    @foreach (var c in CommentairesAffiches)
                    {
                        bool   estMoi    = c.UserId == userId;
                        bool   estRecent = (DateTime.UtcNow - c.CreatedAt).TotalHours < 24;
                        bool   estAgent  = c.User?.Role == "ROLE_AGENT";
                        string init      = (c.User?.Name ?? "?").Length > 0
                                               ? c.User!.Name[0].ToString().ToUpper() : "?";

                        <div class="chat-message @(estMoi ? "moi" : "autre")" @key="c.Id">

                            <!-- Avatar -->
                            <div class="chat-avatar @(estMoi ? "chat-avatar-moi" : (estAgent ? "chat-avatar-agent" : "chat-avatar-autre"))">
                                @init
                            </div>

                            <!-- Bulle + méta -->
                            <div class="chat-bubble-wrapper">

                                <!-- Ligne méta : auteur, badges, suppression -->
                                <div class="chat-meta @(estMoi ? "flex-row-reverse" : "")">
                                    <span class="chat-author">@(estMoi ? "Vous" : (c.User?.Name ?? "Inconnu"))</span>
                                    @if (estAgent && !estMoi)
                                    {
                                        <span class="badge-agent-chat">
                                            <i class="bi bi-shield-check me-1"></i>Agent
                                        </span>
                                    }
                                    @if (estRecent)
                                    {
                                        <span class="badge-recent">
                                            <i class="bi bi-clock me-1"></i>Récent
                                        </span>
                                    }
                                    @if (c.UserId == userId || isAgent)
                                    {
                                        <button class="chat-delete-btn"
                                                @onclick="() => SupprimerCommentaire(c.Id)"
                                                type="button"
                                                title="Supprimer ce commentaire">
                                            <i class="bi bi-trash3"></i>
                                        </button>
                                    }
                                </div>

                                <!-- Contenu de la bulle -->
                                <div class="chat-bubble @(estMoi ? "chat-bubble-moi" : "chat-bubble-autre")">
                                    @c.Contenu
                                </div>

                                <!-- Horodatage -->
                                <div class="chat-date @(estMoi ? "text-end" : "")">
                                    @c.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                </div>

                            </div>
                        </div>
                    }
                </div>
            }

            <!-- Zone de saisie du nouveau commentaire -->
            <div class="mt-4 pt-3 border-top">
                <div class="d-flex gap-2 align-items-start">
                    <!-- Avatar de l'utilisateur connecté -->
                    <div class="chat-avatar chat-avatar-moi flex-shrink-0">
                        @(UserState.Name.Length > 0 ? UserState.Name[0].ToString().ToUpper() : "?")
                    </div>
                    <div class="flex-grow-1">
                        <textarea @bind="nouveauCommentaire"
                                  class="form-control chat-textarea"
                                  rows="2"
                                  placeholder="Écrire un commentaire…"></textarea>
                        <div class="d-flex justify-content-end mt-2">
                            <button class="btn btn-primary btn-sm d-flex align-items-center gap-1"
                                    @onclick="AjouterCommentaire"
                                    disabled="@chargementCommentaire">
                                @if (chargementCommentaire)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                    <span>Envoi…</span>
                                }
                                else
                                {
                                    <i class="bi bi-send"></i>
                                    <span>Envoyer</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }
    [CascadingParameter] private Task<AuthenticationState>? AuthStateTask { get; set; }

    private ConfirmModal? confirmModal;

    // Données chargées depuis l'API
    private DemandeDto?            demande;
    private List<CommentaireDto>   commentaires    = new List<CommentaireDto>();
    private List<UserDto>          agents          = new List<UserDto>();
    private bool                   erreurChargement;

    // Informations de l'utilisateur connecté
    private bool isAgent;
    private Guid userId;

    // État de l'édition complète (mode formulaire)
    private bool   modeEdition     = false;
    private string editTitre       = "";
    private string editDescription = "";
    private string editStatus      = "";
    private string editAgentId     = "";
    private bool   chargementEdit;

    // Actions rapides de l'agent : statut et assignation sans ouvrir le formulaire d'édition
    private string inlineStatus          = "";
    private string inlineAgentId         = "";
    private bool   chargementStatut;
    private bool   chargementAgent;

    // Valeurs en attente de confirmation (entre le changement du select et la validation modale)
    private string pendingInlineStatus   = "";
    private string pendingInlineAgentId  = "";

    // État des commentaires
    private string nouveauCommentaire      = "";
    private bool   chargementCommentaire;

    // Pagination des commentaires : 4 visibles par défaut, dépliables
    private const int NbCommentairesParDefaut = 4;
    private bool      tousCommentairesVisibles = false;

    // Retourne uniquement les commentaires à afficher selon l'état de dépliage
    private IEnumerable<CommentaireDto> CommentairesAffiches =>
        tousCommentairesVisibles
            ? commentaires
            : commentaires.Skip(Math.Max(0, commentaires.Count - NbCommentairesParDefaut));

    // ROLE_AGENT : n'a plus accès au bouton "Modifier" — il utilise les contrôles inline
    // ROLE_USER  : peut modifier uniquement ses propres demandes (titre / description)
    private bool peutModifier  => !isAgent && demande?.UserId == userId;
    private bool peutSupprimer => isAgent  || demande?.UserId == userId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateTask!;
        isAgent = authState.User.IsInRole("ROLE_AGENT");

        var idStr = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
        if (idStr != null) Guid.TryParse(idStr, out userId);

        // Charge la liste des agents si l'utilisateur est un agent (pour l'assignation)
        if (isAgent)
            agents = await UserApi.GetAgentsAsync();

        await ChargerDemande();
    }

    // Charge la demande et ses commentaires depuis l'API
    private async Task ChargerDemande()
    {
        demande = await DemandeApi.GetDemandeAsync(Id);

        if (demande == null)
        {
            erreurChargement = true;
            return;
        }

        commentaires = await CommentaireApi.GetCommentairesAsync(Id);

        // Initialise les champs du formulaire d'édition avec les valeurs actuelles
        editTitre       = demande.Title;
        editDescription = demande.Description;
        editStatus      = demande.Status; // "EnAttente", "EnCours" ou "Terminé"
        editAgentId     = demande.AssignedAgentId?.ToString() ?? "";

        // Synchronise les selects inline (actions rapides de l'agent)
        inlineStatus  = demande.Status;
        inlineAgentId = demande.AssignedAgentId?.ToString() ?? "";
    }

    // Ouvre la popup de confirmation avant de sauvegarder
    private void DemanderConfirmationSauvegarde()
        => confirmModal!.Afficher(
            "Confirmer la modification",
            "Voulez-vous enregistrer les modifications apportées à cette demande ?",
            SauvegarderAsync,
            libelle: "Confirmer",
            classe:  "btn-primary");

    // Sauvegarde les modifications de la demande via PUT /api/demandes/{id}
    private async Task SauvegarderAsync()
    {
        chargementEdit = true;

        Guid? agentId = Guid.TryParse(editAgentId, out var g) ? g : null;

        var request = new UpdateDemandeRequest(
            Title:           editTitre,
            Description:     editDescription,
            Status:          editStatus,           // "EnAttente", "EnCours" ou "Terminé"
            AssignedAgentId: isAgent ? agentId : demande!.AssignedAgentId,
            AssignedAt:      isAgent && agentId.HasValue
                                 ? (demande!.AssignedAt ?? DateTime.UtcNow)
                                 : null);

        var erreur = await DemandeApi.ModifierDemandeAsync(Id, request);

        chargementEdit = false;

        if (erreur != null)
        {
            Toast.Show(erreur, "danger");
        }
        else
        {
            Toast.Show("Demande modifiée avec succès.", "success");
            modeEdition = false;
            await ChargerDemande();
        }

        // Force le re-rendu de DemandeDetail car le callback s'exécute
        // depuis ConfirmModal — Blazor ne remonte pas automatiquement au parent
        StateHasChanged();
    }

    // Ouvre la popup de confirmation puis supprime la demande si confirmé
    private void Supprimer()
        => confirmModal!.Afficher(
            "Supprimer la demande",
            "Confirmer la suppression de cette demande ? Cette action est irréversible.",
            async () =>
            {
                var erreur = await DemandeApi.SupprimerDemandeAsync(Id);
                if (erreur == null)
                {
                    Toast.Show("Demande supprimée.", "success");
                    Nav.NavigateTo("/demandes");
                }
                else
                {
                    Toast.Show(erreur, "danger");
                }
            },
            libelle: "Supprimer",
            classe:  "btn-danger");

    // Ajoute un commentaire sur la demande
    private async Task AjouterCommentaire()
    {
        if (string.IsNullOrWhiteSpace(nouveauCommentaire)) return;

        chargementCommentaire = true;

        var erreur = await CommentaireApi.AjouterCommentaireAsync(Id, nouveauCommentaire);

        chargementCommentaire = false;

        if (erreur != null)
        {
            Toast.Show(erreur, "danger");
        }
        else
        {
            Toast.Show("Commentaire ajouté.", "success");
            nouveauCommentaire = "";
            commentaires = await CommentaireApi.GetCommentairesAsync(Id);
        }
    }

    // Ouvre la popup de confirmation puis supprime le commentaire si confirmé
    private void SupprimerCommentaire(Guid commentaireId)
        => confirmModal!.Afficher(
            "Supprimer le commentaire",
            "Confirmer la suppression de ce commentaire ?",
            async () =>
            {
                var erreur = await CommentaireApi.SupprimerCommentaireAsync(commentaireId);
                if (erreur == null)
                {
                    Toast.Show("Commentaire supprimé.", "success");
                    commentaires = await CommentaireApi.GetCommentairesAsync(Id);
                    StateHasChanged();
                }
                else
                {
                    Toast.Show(erreur, "danger");
                }
            },
            libelle: "Supprimer",
            classe:  "btn-danger");

    // Annule l'édition
    private void AnnulerEdition()
        => modeEdition = false;

    // Intercepte le changement de statut, mémorise la valeur et demande confirmation
    // Le select est visuellement remis à l'ancienne valeur pendant que le modal est ouvert
    private void OnStatutChange(ChangeEventArgs e)
    {
        pendingInlineStatus = e.Value?.ToString() ?? "";
        if (pendingInlineStatus == inlineStatus) return;

        confirmModal!.Afficher(
            "Confirmer le changement de statut",
            $"Passer le statut de « {LibelleStatut(inlineStatus)} » à « {LibelleStatut(pendingInlineStatus)} » ?",
            ConfirmerChangementStatut,
            libelle: "Confirmer",
            classe:  "btn-primary");

        // Déclenche un re-rendu pour remettre visuellement le select sur l'ancienne valeur
        // tant que l'utilisateur n'a pas confirmé
        StateHasChanged();
    }

    // Applique le changement de statut après confirmation de l'agent
    private async Task ConfirmerChangementStatut()
    {
        inlineStatus     = pendingInlineStatus;
        chargementStatut = true;
        StateHasChanged();

        var request = new UpdateDemandeRequest(
            Title:           demande!.Title,
            Description:     demande.Description,
            Status:          inlineStatus,
            AssignedAgentId: demande.AssignedAgentId,
            AssignedAt:      demande.AssignedAt);

        var erreur = await DemandeApi.ModifierDemandeAsync(Id, request);
        chargementStatut = false;

        if (erreur == null)
        {
            Toast.Show("Statut mis à jour avec succès.", "success");
            await ChargerDemande();
        }
        else
        {
            Toast.Show(erreur, "danger");
            inlineStatus = demande!.Status; // revert en cas d'erreur API
        }

        // Force le re-rendu du parent car le callback est exécuté depuis ConfirmModal
        StateHasChanged();
    }

    // Intercepte le changement d'agent, mémorise la valeur et demande confirmation
    private void OnAgentChange(ChangeEventArgs e)
    {
        pendingInlineAgentId = e.Value?.ToString() ?? "";
        if (pendingInlineAgentId == inlineAgentId) return;

        var oldName = agents.FirstOrDefault(a => a.Id.ToString() == inlineAgentId)?.Name ?? "Aucun";
        var newName = agents.FirstOrDefault(a => a.Id.ToString() == pendingInlineAgentId)?.Name ?? "Aucun";

        confirmModal!.Afficher(
            "Confirmer l'assignation",
            $"Assigner ce ticket à « {newName} » (actuellement : « {oldName} ») ?",
            ConfirmerChangementAgent,
            libelle: "Confirmer",
            classe:  "btn-primary");

        StateHasChanged();
    }

    // Applique le changement d'agent après confirmation de l'agent
    private async Task ConfirmerChangementAgent()
    {
        inlineAgentId   = pendingInlineAgentId;
        chargementAgent = true;
        StateHasChanged();

        Guid? agentId = Guid.TryParse(inlineAgentId, out var g) ? g : null;

        var request = new UpdateDemandeRequest(
            Title:           demande!.Title,
            Description:     demande.Description,
            Status:          demande.Status,
            AssignedAgentId: agentId,
            AssignedAt:      agentId.HasValue ? (demande.AssignedAt ?? DateTime.UtcNow) : null);

        var erreur = await DemandeApi.ModifierDemandeAsync(Id, request);
        chargementAgent = false;

        if (erreur == null)
        {
            var msg = agentId.HasValue ? "Ticket assigné avec succès." : "Assignation retirée.";
            Toast.Show(msg, "success");
            await ChargerDemande();
        }
        else
        {
            Toast.Show(erreur, "danger");
            inlineAgentId = demande!.AssignedAgentId?.ToString() ?? ""; // revert en cas d'erreur API
        }

        StateHasChanged();
    }

    // Traduit le statut API en libellé lisible
    private static string LibelleStatut(string status) => status switch
    {
        "EnAttente" => "En attente",
        "EnCours"   => "En cours",
        "Terminé"   => "Terminé",
        _           => status
    };

    // Classe Bootstrap pour le badge de statut
    private static string ClasseStatut(string status) => status switch
    {
        "EnAttente" => "bg-warning text-dark",
        "EnCours"   => "bg-info text-dark",
        "Terminé"   => "bg-success",
        _           => "bg-secondary"
    };
}
