@page "/utilisateurs"
@attribute [Authorize(Roles = "ROLE_AGENT")]
@inject UserApiService UserApi

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Utilisateurs</h3>
</div>

<!-- Barre de filtres (ROLE_AGENT) -->
<div class="filter-bar">
    <div class="row g-2 align-items-end">

        <!-- Filtre par statut actif/inactif -->
        <div class="col-12 col-sm-6 col-lg-2">
            <label class="filter-label">Statut</label>
            <select @bind="filtreActif" class="form-select form-select-sm">
                <option value="">Tous</option>
                <option value="true">Actifs</option>
                <option value="false">Inactifs</option>
            </select>
        </div>

        <!-- Filtre par email -->
        <div class="col-12 col-sm-6 col-lg-4">
            <label class="filter-label">Email</label>
            <input @bind="filtreEmail" class="form-control form-control-sm"
                   placeholder="Rechercher par email..." />
        </div>

        <!-- Filtre par rôle -->
        <div class="col-12 col-sm-6 col-lg-2">
            <label class="filter-label">Rôle</label>
            <select @bind="filtreRole" class="form-select form-select-sm">
                <option value="">Tous</option>
                <option value="ROLE_USER">Utilisateur</option>
                <option value="ROLE_AGENT">Agent</option>
            </select>
        </div>

        <!-- Boutons -->
        <div class="col-12 col-sm-auto ms-sm-auto">
            <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm flex-grow-1 flex-sm-grow-0"
                        @onclick="Filtrer">
                    <i class="bi bi-funnel me-1"></i>Filtrer
                </button>
                <button class="btn btn-outline-secondary btn-sm flex-grow-1 flex-sm-grow-0"
                        @onclick="Reinitialiser">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Réinitialiser
                </button>
            </div>
        </div>

    </div>
</div>

<!-- Tableau des utilisateurs -->
@if (utilisateurs == null)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Chargement...</p>
    </div>
}
else if (utilisateurs.Count == 0)
{
    <div class="alert alert-info">Aucun utilisateur trouvé.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Rôle</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var u in utilisateurs)
                {
                    <tr>
                        <td><strong>@u.Name</strong></td>
                        <td>@u.Email</td>
                        <td>
                            @if (u.Role == "ROLE_AGENT")
                            {
                                <span class="badge bg-primary">Agent</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Utilisateur</span>
                            }
                        </td>
                        <td>
                            @if (u.Actif)
                            {
                                <span class="badge bg-success">Actif</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Inactif</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<UserDto>? utilisateurs;

    // Valeurs des filtres
    private string filtreActif = "";
    private string filtreEmail = "";
    private string filtreRole  = "";

    protected override async Task OnInitializedAsync()
        => await ChargerUtilisateurs();

    // Charge les utilisateurs selon les filtres actifs
    private async Task ChargerUtilisateurs()
    {
        utilisateurs = null;

        bool? actif = string.IsNullOrEmpty(filtreActif) ? null : bool.Parse(filtreActif);

        utilisateurs = await UserApi.GetUtilisateursAsync(
            actif: actif,
            email: string.IsNullOrEmpty(filtreEmail) ? null : filtreEmail,
            role:  string.IsNullOrEmpty(filtreRole)  ? null : filtreRole);
    }

    private async Task Filtrer()      => await ChargerUtilisateurs();
    private async Task Reinitialiser()
    {
        filtreActif = "";
        filtreEmail = "";
        filtreRole  = "";
        await ChargerUtilisateurs();
    }
}
